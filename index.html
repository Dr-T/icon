<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Logo生成器</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- 顶部标题区域 -->
    <header class="header">
        <h1>AI Logo生成器</h1>
        <p>输入插件信息，自动生成专属Logo</p>
    </header>

    <!-- 主要内容区域 -->
    <main class="main">
        <!-- 输入表单区域 -->
        <section class="form-section">
            <form id="logoForm" class="logo-form">
                <div class="form-group">
                    <label for="pluginName">插件名称</label>
                    <input type="text" id="pluginName" name="pluginName" required 
                           placeholder="请输入插件名称">
                </div>
                <div class="form-group">
                    <label for="pluginDesc">插件描述</label>
                    <textarea id="pluginDesc" name="pluginDesc" required 
                              placeholder="请输入插件的功能描述"></textarea>
                </div>
                <button type="submit" class="generate-btn">生成Logo</button>
            </form>
        </section>

        <!-- Logo展示区域 -->
        <section class="logo-section">
            <div class="logo-container">
                <!-- 进度条 -->
                <div class="progress-container" style="display: none;">
                    <div class="progress-bar"></div>
                    <div class="progress-text"></div>
                </div>
                <!-- 加载动画 -->
                <div class="loading-spinner" style="display: none;"></div>
                <!-- Logo图片 -->
                <img id="logoImage" class="logo-image" style="display: none;" alt="生成的Logo">
            </div>
        </section>
    </main>

    <!-- 错误提示弹窗 -->
    <div id="errorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>错误提示</h2>
            <p id="errorMessage"></p>
        </div>
    </div>

    <!-- 底部信息区域 -->
    <footer class="footer">
        <p>基于OpenAI API开发 | 响应式设计</p>
    </footer>

    <script>
        document.getElementById('logoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 获取表单数据
            const pluginName = document.getElementById('pluginName').value;
            const pluginDesc = document.getElementById('pluginDesc').value;
            
            // 显示进度条，隐藏其他元素
            const progressContainer = document.querySelector('.progress-container');
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.progress-text');
            const spinner = document.querySelector('.loading-spinner');
            const logoImage = document.getElementById('logoImage');
            
            progressContainer.style.display = 'block';
            spinner.style.display = 'none';
            logoImage.style.display = 'none';
            
            try {
                // 发送请求到后端服务
                const response = await fetch('http://localhost:3000/generate-logo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pluginName,
                        pluginDesc
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const updates = chunk.split('\n').filter(Boolean).map(str => JSON.parse(str));

                    for (const update of updates) {
                        // 更新进度条
                        progressBar.style.width = `${update.progress}%`;
                        progressText.textContent = update.message;

                        if (update.status === 'completed') {
                            // 处理完成，显示下载按钮
                            progressContainer.style.display = 'none';
                            
                            // 创建下载按钮
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-btn';
                            downloadBtn.textContent = '下载全部尺寸';
                            downloadBtn.onclick = async () => {
                                // 创建一个JSZip实例
                                const zip = new JSZip();
                                
                                // 添加所有尺寸的图片到zip
                                for (const sizeData of update.sizes) {
                                    const imgData = atob(sizeData.data);
                                    const arrayBuffer = new ArrayBuffer(imgData.length);
                                    const uint8Array = new Uint8Array(arrayBuffer);
                                    
                                    for (let i = 0; i < imgData.length; i++) {
                                        uint8Array[i] = imgData.charCodeAt(i);
                                    }
                                    
                                    zip.file(`icon-${sizeData.size}.png`, uint8Array);
                                }
                                
                                // 生成并下载zip文件
                                const content = await zip.generateAsync({type: 'blob'});
                                const downloadUrl = URL.createObjectURL(content);
                                const link = document.createElement('a');
                                link.href = downloadUrl;
                                link.download = 'images.zip';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(downloadUrl);
                            };
                            
                            // 将下载按钮添加到logo容器中，插入到图片元素之前
                            const logoContainer = document.querySelector('.logo-container');
                            const logoImage = document.getElementById('logoImage');
                            logoContainer.insertBefore(downloadBtn, logoImage);
                        } else if (update.originalUrl) {
                            // 显示原始图片
                            logoImage.src = update.originalUrl;
                            logoImage.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                const errorModal = document.getElementById('errorModal');
                const errorMessage = document.getElementById('errorMessage');
                const closeBtn = document.querySelector('.close-btn');
                
                // 隐藏进度条
                progressContainer.style.display = 'none';
                
                // 显示错误信息
                errorMessage.textContent = error.message || '生成Logo时出现错误，请重试';
                errorModal.style.display = 'block';
                
                // 关闭按钮事件
                closeBtn.onclick = function() {
                    errorModal.style.display = 'none';
                }
                
                // 点击模态框外部关闭
                window.onclick = function(event) {
                    if (event.target == errorModal) {
                        errorModal.style.display = 'none';
                    }
                }
                
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html>