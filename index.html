<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGO智能生成</title>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="qr-float.js"></script>
</head>
<body>
    <!-- 顶部标题区域 -->
    <header class="header">
        <div class="header-content">
            <div class="title-container">
                <img src="assets/logo.svg" alt="Logo" class="site-logo">
                <div class="title-text">
                    <h1>Chrome插件 LOGO 生成</h1>
                    <p>输入插件信息，自动生成专属LOGO及icons图标包</p>
                </div>
            </div>
            <!-- 提示条移到标题区域右侧 -->
            <div class="notification-container" id="notificationBar">
                <div class="notification-content">
                    <span>本项目为 WaytoAGI 编程挑战 参赛项目</span>
                    <a href="https://waytoagi.feishu.cn/record/V4sOrBJNheHeZccQ84Ocz7RznMd" target="_blank" rel="noreferrer">点击投票支持</a>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="main">
        <!-- 输入表单区域 -->
        <section class="form-section">
            <form id="logoForm" class="logo-form">
                <div class="form-group">
                    <label for="pluginName">插件名称</label>
                    <input type="text" id="pluginName" name="pluginName" required 
                           placeholder="请输入插件名称">
                </div>
                <div class="form-group">
                    <label for="pluginDesc">插件描述</label>
                    <textarea id="pluginDesc" name="pluginDesc" required 
                              placeholder="输入插件功能描述，或你希望图片中包含的元素"></textarea>
                </div>
                <button type="submit" class="generate-btn">生成LOGO</button>
                <button type="button" class="upload-btn" id="uploadBtn" onclick="handleUploadClick()">上传LOGO</button>
                <input type="file" id="logoUpload" accept="image/*" style="display: none" onchange="handleLogoUpload(event)">
            </form>
        </section>

        <!-- Logo展示区域 -->
        <section class="logo-section">
            <div class="logo-container">
                <!-- 进度条 -->
                <div class="progress-container" style="display: none;">
                    <div class="progress-bar"></div>
                    <div class="progress-text"></div>
                </div>
                <!-- 加载动画 -->
                <div class="loading-spinner" style="display: none;"></div>
                <!-- Logo图片 -->
                <img id="logoImage" class="logo-image" style="display: none;" alt="生成的Logo">
            </div>
        </section>
    </main>

    <!-- 错误提示弹窗 -->
    <div id="errorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>生成失败</h2>
            <p id="errorMessage"></p>
            <p class="contact-info">如遇失败，请联系我：xandertangv</p>
        </div>
    </div>
    
    <!-- Toast提示 -->
    <div id="toastMessage" class="toast-message" style="display: none;">
        <div class="toast-content">
            <span id="toastText">请等待当前生成任务完成</span>
        </div>
    </div>

    <!-- 底部信息区域 -->
    <footer class="footer">
        v0.1.0 | Powered by <a href="https://openai.com/index/dall-e-3/" target="_blank" rel="noreferrer">DALL·E 3</a><a href="https://www.trae.ai/" target="_blank" rel="noreferrer">TraeAI</a><a href="https://vercel.com/" target="_blank" rel="noreferrer">Vercel</a></p>
    </footer>

    <script>
        // 防重复点击函数
        function disableButton(button, text) {
            // 保存原始文本
            const originalText = button.textContent;
            // 禁用按钮
            button.disabled = true;
            button.classList.add('button-disabled');
            // 如果提供了文本，则更改按钮文本
            if (text) {
                button.textContent = text;
            }
            
            return function enableButton() {
                // 恢复按钮状态
                button.disabled = false;
                button.classList.remove('button-disabled');
                // 恢复原始文本
                button.textContent = originalText;
            };
        }
        
        // 显示Toast提示函数
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toastMessage');
            const toastText = document.getElementById('toastText');
            
            // 设置提示文本
            toastText.textContent = message;
            
            // 显示Toast
            toast.style.display = 'block';
            setTimeout(() => toast.classList.add('show'), 10);
            
            // 设置自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.style.display = 'none', 300);
            }, duration);
        }
        
        // 标记生成状态的变量
        let isGenerating = false;
        
        document.getElementById('logoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 获取生成按钮
            const generateBtn = document.querySelector('.generate-btn');
            const uploadBtn = document.getElementById('uploadBtn');
            
            // 检查生成状态
            if (isGenerating) {
                showToast('请等待当前生成任务完成');
                return;
            }
            
            // 设置生成状态为true
            isGenerating = true;
            
            // 禁用按钮并显示loading状态
            generateBtn.disabled = true;
            uploadBtn.disabled = true;
            generateBtn.textContent = '生成中...';
            uploadBtn.textContent = '请等待...';
            generateBtn.classList.add('button-disabled');
            uploadBtn.classList.add('button-disabled');
            
            const enableButton = () => {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成Logo';
                generateBtn.classList.remove('button-disabled');
            };
            
            const enableUploadButton = () => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = '上传Logo';
                uploadBtn.classList.remove('button-disabled');
            };
            
            // 获取表单数据
            const pluginName = document.getElementById('pluginName').value;
            const pluginDesc = document.getElementById('pluginDesc').value;
            
            // 清理之前的内容
            const logoContainer = document.querySelector('.logo-container');
            const downloadBtn = logoContainer.querySelector('.download-btn');
            if (downloadBtn) {
                logoContainer.removeChild(downloadBtn);
            }
            
            // 显示进度条，隐藏其他元素
            const progressContainer = document.querySelector('.progress-container');
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.progress-text');
            const spinner = document.querySelector('.loading-spinner');
            const logoImage = document.getElementById('logoImage');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '准备生成...';
            spinner.style.display = 'block';
            logoImage.style.display = 'none';
            
            try {
                console.log('正在发送生成Logo请求...');
                // 发送请求到后端服务
                const response = await fetch('/generate-logo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pluginName,
                        pluginDesc
                    })
                });

                console.log('收到服务器响应:', response.status);
                
                if (!response.ok && response.headers.get('content-type')?.includes('application/json')) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `请求失败: ${response.status}`);
                } else if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || errorData.error || `请求失败: ${response.status}`);
                }

                if (!response.body) {
                    throw new Error('浏览器不支持流式响应处理');
                }
                
                console.log('开始处理流式响应...');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                let buffer = '';
                let hasError = false;
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        console.log('流式响应读取完毕');
                        break;
                    }
                    
                    // 解码新数据并添加到缓冲区
                    const text = decoder.decode(value, { stream: true });
                    console.log('接收到原始数据:', text);
                    buffer += text;
                    
                    // 处理完整的JSON对象
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // 保留最后一个可能不完整的行
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        
                        try {
                            console.log('解析JSON数据:', line);
                            const update = JSON.parse(line);
                            
                            if (update.status === 'error') {
                                throw new Error(update.error);
                            }
                            
                            // 更新进度条和loading状态
                            progressBar.style.width = `${update.progress}%`;
                            progressText.textContent = update.message;
                            spinner.style.display = update.showSpinner ? 'block' : 'none';
                            
                            if (update.status === 'completed') {
                                console.log('处理完成，显示下载按钮');
                                // 处理完成，显示下载按钮
                                progressContainer.style.display = 'none';
                                
                                // 创建下载按钮
                                const downloadBtn = document.createElement('button');
                                downloadBtn.className = 'download-btn';
                                downloadBtn.textContent = '下载全部尺寸';
                                downloadBtn.onclick = async () => {
                                    // 创建一个JSZip实例
                                    const zip = new JSZip();
                                    
                                    // 添加所有尺寸的图片到zip
                                    for (const sizeData of update.sizes) {
                                        const imgData = atob(sizeData.data);
                                        const arrayBuffer = new ArrayBuffer(imgData.length);
                                        const uint8Array = new Uint8Array(arrayBuffer);
                                        
                                        for (let i = 0; i < imgData.length; i++) {
                                            uint8Array[i] = imgData.charCodeAt(i);
                                        }
                                        
                                        zip.file(`icon${sizeData.size}.png`, uint8Array);
                                    }
                                    
                                    // 生成并下载zip文件
                                    const content = await zip.generateAsync({type: 'blob'});
                                    const downloadUrl = URL.createObjectURL(content);
                                    const link = document.createElement('a');
                                    link.href = downloadUrl;
                                    link.download = 'images.zip';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(downloadUrl);
                                };
                                
                                // 将下载按钮添加到logo容器中
                                logoContainer.insertBefore(downloadBtn, logoImage);
                            } else if (update.originalUrl) {
                                console.log('显示原始图片:', update.originalUrl);
                                // 显示原始图片
                                logoImage.src = update.originalUrl;
                                logoImage.style.display = 'block';
                            } else if (update.error) {
                                hasError = true;
                                throw new Error(update.error);
                            }
                        } catch (e) {
                            console.error('解析JSON失败:', line, e);
                            if (!hasError) {
                                hasError = true;
                                throw new Error(e.message || update?.error || '解析服务器响应失败');
                            }
                        }
                    }
                }
                
                if (buffer.trim()) {
                    try {
                        // 处理缓冲区中最后一行
                        console.log('处理剩余响应数据:', buffer);
                        const update = JSON.parse(buffer);
                        
                        if (update.status === 'completed') {
                            console.log('最终处理完成');
                            progressContainer.style.display = 'none';
                            
                            // 创建下载按钮
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-btn';
                            downloadBtn.textContent = '下载全部尺寸';
                            downloadBtn.onclick = async () => {
                                // 创建一个JSZip实例
                                const zip = new JSZip();
                                
                                // 添加所有尺寸的图片到zip
                                for (const sizeData of update.sizes) {
                                    const imgData = atob(sizeData.data);
                                    const arrayBuffer = new ArrayBuffer(imgData.length);
                                    const uint8Array = new Uint8Array(arrayBuffer);
                                    
                                    for (let i = 0; i < imgData.length; i++) {
                                        uint8Array[i] = imgData.charCodeAt(i);
                                    }
                                    
                                    zip.file(`icon${sizeData.size}.png`, uint8Array);
                                }
                                
                                // 生成并下载zip文件
                                const content = await zip.generateAsync({type: 'blob'});
                                const downloadUrl = URL.createObjectURL(content);
                                const link = document.createElement('a');
                                link.href = downloadUrl;
                                link.download = 'images.zip';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(downloadUrl);
                            };
                            
                            // 将下载按钮添加到logo容器中
                            logoContainer.insertBefore(downloadBtn, logoImage);
                        } else if (update.error) {
                            throw new Error(update.error);
                        }
                    } catch (e) {
                        console.error('解析最后响应数据失败:', e);
                    }
                }
            }
            catch (error) {
                console.error('处理过程中发生错误:', error);
                const errorModal = document.getElementById('errorModal');
                const errorMessage = document.getElementById('errorMessage');
                const closeBtn = document.querySelector('.close-btn');
                
                // 隐藏进度条
                progressContainer.style.display = 'none';
                
                // 显示错误信息
                errorMessage.textContent = error.message || '生成Logo时出现错误，请重试';
                errorModal.style.display = 'block';
                setTimeout(() => errorModal.classList.add('show'), 10);
                
                // 关闭按钮事件
                closeBtn.onclick = function() {
                    errorModal.classList.remove('show');
                    setTimeout(() => errorModal.style.display = 'none', 300);
                }
                
                // 点击模态框外部关闭
                window.onclick = function(event) {
                    if (event.target == errorModal) {
                        errorModal.classList.remove('show');
                        setTimeout(() => errorModal.style.display = 'none', 300);
                    }
                }
            } finally {
                // 无论成功还是失败，都恢复生成按钮状态
                enableButton();
                // 恢复上传按钮状态
                enableUploadButton();
                // 重置生成状态
                isGenerating = false;
            }
        });
    </script>
    <script>window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };</script>
    <script>
        // 初始化Vercel Analytics
        va('script', { url: '/_vercel/insights/script.js' });
    </script>
    <script>
        // 处理提示条关闭
        // document.getElementById('closeNotification').addEventListener('click', function() {
        //     document.getElementById('notificationBar').style.display = 'none';
            // 可选：保存到本地存储，使通知在未来访问中保持关闭状态
        //     localStorage.setItem('notificationClosed', 'true');
        // });

        // 检查是否应该显示提示条
        // document.addEventListener('DOMContentLoaded', function() {
        //     if (localStorage.getItem('notificationClosed') === 'true') {
        //         document.getElementById('notificationBar').style.display = 'none';
        //     }
        // });
    </script>
</body>
</html>
<script>
    function handleUploadClick() {
        // 获取上传按钮并禁用它
        const uploadBtn = document.getElementById('uploadBtn');
        const enableButton = disableButton(uploadBtn, '选择中...');
        
        // 点击隐藏的文件输入框
        document.getElementById('logoUpload').click();
        
        // 短暂延迟后恢复按钮状态（如果用户没有选择文件）
        setTimeout(() => {
            // 检查是否已经选择了文件
            if (!document.getElementById('logoUpload').files.length) {
                enableButton();
            }
        }, 1000);
    }
    
    async function handleLogoUpload(event) {
        const file = event.target.files[0];
        
        // 如果用户取消了文件选择，则直接返回
        if (!file) {
            // 恢复上传按钮状态
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('button-disabled');
            uploadBtn.textContent = '上传LOGO';
            return;
        }
        
        // 禁用上传按钮
        const uploadBtn = document.getElementById('uploadBtn');
        const enableUploadButton = disableButton(uploadBtn, '处理中...');
        if (!file) return;
    
        // 清理之前的内容
        const logoContainer = document.querySelector('.logo-container');
        const downloadBtn = logoContainer.querySelector('.download-btn');
        if (downloadBtn) {
            logoContainer.removeChild(downloadBtn);
        }
    
        // 显示进度条，隐藏其他元素
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        const progressText = document.querySelector('.progress-text');
        const spinner = document.querySelector('.loading-spinner');
        const logoImage = document.getElementById('logoImage');
        
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        spinner.style.display = 'none';
        logoImage.style.display = 'none';
    
        const formData = new FormData();
        formData.append('logo', file);
    
        try {
            console.log('开始上传图片...');
            const response = await fetch('/upload-logo', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `请求失败: ${response.status}`);
            }
            
            if (!response.body) {
                throw new Error('浏览器不支持流式响应处理');
            }

            console.log('开始处理上传响应...');
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            let buffer = '';
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    console.log('上传响应读取完毕');
                    break;
                }
                
                // 解码新数据并添加到缓冲区
                buffer += decoder.decode(value, { stream: true });
                
                // 处理完整的JSON对象
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // 保留最后一个可能不完整的行
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    try {
                        console.log('解析上传响应JSON:', line);
                        const update = JSON.parse(line);
                        
                        // 更新进度条
                        progressBar.style.width = `${update.progress}%`;
                        progressText.textContent = update.message;
                        
                        if (update.status === 'completed') {
                            console.log('上传处理完成');
                            // 处理完成，显示下载按钮
                            progressContainer.style.display = 'none';
                            
                            // 创建下载按钮
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-btn';
                            downloadBtn.textContent = '下载全部尺寸';
                            downloadBtn.onclick = async () => {
                                // 创建一个JSZip实例
                                const zip = new JSZip();
                                
                                // 添加所有尺寸的图片到zip
                                for (const sizeData of update.sizes) {
                                    const imgData = atob(sizeData.data);
                                    const arrayBuffer = new ArrayBuffer(imgData.length);
                                    const uint8Array = new Uint8Array(arrayBuffer);
                                    
                                    for (let i = 0; i < imgData.length; i++) {
                                        uint8Array[i] = imgData.charCodeAt(i);
                                    }
                                    
                                    zip.file(`icon${sizeData.size}.png`, uint8Array);
                                }
                                
                                // 生成并下载zip文件
                                const content = await zip.generateAsync({type: 'blob'});
                                const downloadUrl = URL.createObjectURL(content);
                                const link = document.createElement('a');
                                link.href = downloadUrl;
                                link.download = 'images.zip';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(downloadUrl);
                            };
                            
                            // 将下载按钮添加到logo容器中
                            logoContainer.insertBefore(downloadBtn, logoImage);
                        } else if (update.originalUrl) {
                            console.log('显示原始上传图片');
                            // 显示原始图片
                            logoImage.src = update.originalUrl;
                            logoImage.style.display = 'block';
                        }
                    } catch (e) {
                        console.error('解析上传响应JSON失败:', line, e);
                    }
                }
            }
        } catch (error) {
            console.error('上传处理过程中发生错误:', error);
            const errorModal = document.getElementById('errorModal');
            const errorMessage = document.getElementById('errorMessage');
            const closeBtn = document.querySelector('.close-btn');
            
            // 隐藏进度条和加载动画
            progressContainer.style.display = 'none';
            spinner.style.display = 'none';
            
            // 显示错误信息
            errorMessage.textContent = error.message || '处理图片时出现错误，请重试';
            errorModal.style.display = 'block';
            
            // 添加联系方式提示
            const contactInfo = document.createElement('div');
            contactInfo.className = 'contact-info';
            contactInfo.textContent = '如遇失败，请联系我：xandertangv';
            document.querySelector('.modal-content').appendChild(contactInfo);
            
            // 关闭按钮事件
            closeBtn.onclick = function() {
                errorModal.style.display = 'none';
            }
            
            // 点击模态框外部关闭
            window.onclick = function(event) {
                if (event.target == errorModal) {
                    errorModal.style.display = 'none';
                }
            }
        } finally {
            // 无论成功还是失败，都恢复上传按钮状态
            enableUploadButton();
        }
    }
</script>